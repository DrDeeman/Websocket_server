{"version":3,"file":"ws.js","names":["fs","require","pg","os","cluster","jwt","config","user","process","env","DB_USER","database","DATABASE","password","PASSWORD","port","PORT","host","HOST","connStr","isMaster","client","Client","connect","err","done","console","log","on","data","worker_id","workers","send","payload","i","fork","query","worker","code","id","isWorker","len","arr_ws","arr_ws_admin","_arr_ws$message$idc","message","JSON","parse","idc","forEach","ws","Number","argv","open","wss","App","upgrade","response","request","context","_request$getHeader","arr_cookie","wsInfo","getHeader","split","map","cookie","_c$","_c$2","c","trim","undefined","verify","decoded","id_user","isAlive","role","end","pong","ping","_arr_ws$ws$id_user$le","_arr_ws$ws$id_user","push","isClose","length","drain","getBufferedAmount","close","listen","clearWSStack","stack","clearPool","setInterval","keys","Object","start_key","end_key","cycleClearPool","key","_stack$key","reIndex","filter","setTimeout"],"sources":["../ws.js"],"sourcesContent":["const fs = require('fs');\nconst pg = require('pg');\nconst os = require('os');\nconst cluster = require('cluster');\nvar jwt = require('jsonwebtoken');\nrequire('dotenv').config();\n\n\n/*\nconst httpsServer = new https.createServer({\n         cert:fs.readFileSync('/etc/apache2/ssl/cert.pem'),\n\t\t key:fs.readFileSync('/etc/apache2/ssl/cert.key')\n});\n*/\n\n\nvar config = {\n\tuser:process.env.DB_USER,\n\tdatabase:process.env.DATABASE,\n\tpassword:process.env.PASSWORD,\n\tport:process.env.PORT,\n\thost:process.env.HOST\n};\n\n\tvar connStr = `postgres://${config.user}:${config.password}@${config.host}/${config.database}`;\n\n\t\n\n\nif(cluster.isMaster){//если процесс в кластере - главный\n\n\tconst client = new pg.Client(connStr); //делаем соединение с бд\n\n\n\t\nclient.connect(async(err,client,done)=>{\n\tif(err)\n\tconsole.log('err');\n\telse\n\t{\n\t\n\t\t\n\n\t\n\n\t\t\n\nclient.on('notification',(data)=>{//привязываемся к событию и слушаем\n\t//for(var worker_id in cluster.workers)//при получении сообщения рассылаем всем воркерам\n\tfor(var worker_id in cluster.workers)\n\t    cluster.workers[worker_id].send(data.payload);\n\n\t\t});\n\t\t\n\t\tfor(var i=0; i<10;i++)\n\t\tcluster.fork();//делаем 10 воркеров на каждый процесс\t\n\n \n\n\t\n}\n});\n\nconst query = client.query(\"LISTEN ws_event\");\n\n\t\n\tcluster.on('exit',function(worker,code){//если воркер умер, пересоздаем еще один\n\t\tconsole.log('child worker '+worker.id+' died');\n\t\tcluster.fork();\n\t});\n\t\n\t\n\t\n}else if(cluster.isWorker){\n\tvar len = 0;\n\tvar arr_ws = [];//каждый дочерний воркер имеет пул вебсокет-подключений\n\tvar arr_ws_admin = [];\n\t//const wss = new WebSocketServer.Server({\n\t//\tport:port\n\t\t\n\t//});//и слушает порт, который был передан оновному процессу\n\t\n\tprocess.on('message',function(data){\n\t\ttry{\n\t\t\n\t\tvar message = JSON.parse(data);\n\t    arr_ws[message.idc]?.forEach(ws=>ws.send(data));\n\t   \n\n\t\t}catch(err){\n\t\t//\tconsole.log(err);\n\t\t\t//console.log(data);\n\t\t\t\n\t\t};\n\t});\n\t\n\tprocess.on('error',function(data){\n\t\tconsole.log(data);\n\t});\n\t\nconsole.log('create child worker  '+cluster.worker.id);\n\n\n\n\nconst port = Number(process.argv[2]);\nthis.open = 0\n\n\n\nvar wss = require('uWebSockets.js').App({})\n    .ws('/*', {\n\t\n\t  upgrade:(response,request,context)=>{\n        \n\t\tvar arr_cookie = [];\n        var wsInfo= {};\n\n\n\n\t\trequest.getHeader('cookie')?.split(';').map(cookie=>{\n\t\t\n      var c = cookie.split('=');\n\t  arr_cookie[c[0]?.trim()] = c[1]?.trim();\n\t});\n\n\t\nif(arr_cookie['ws_token']!=undefined){\n\n\tjwt.verify(arr_cookie['ws_token'],'secret_key',function(err,decoded){\n\t\tif(decoded!=undefined){\t\t\n\t\t\t\n\t\t\twsInfo.id_user = Number(decoded.id); \n\t\t\twsInfo.isAlive = true;   \n\t\t\twsInfo.role = decoded.role;    \n\t\t\t\n\t\t\tresponse.upgrade( // upgrade to websocket\n         wsInfo, // 1st argument sets which properties to pass to ws object, in this case ip address\n         request.getHeader('sec-websocket-key'),\n         request.getHeader('sec-websocket-protocol'),\n         request.getHeader('sec-websocket-extensions'), // 3 headers are used to setup websocket\n         context // also used to setup websocket\n      );\n\n\t  \n} else {\n\tconsole.log('fast close');\n\tresponse.end(); \n}\n\t\n\t\t   \n\t\t});\n} else {\n\tconsole.log('not ws');\n\tconsole.log(arr_cookie);\n\tresponse.end();\n}\n\n        \n\n\t  },\n\n\n      pong:(ws)=>{\n        ws.isAlive = true;\n\t  },\n\t  ping:(ws)=>{\n         ws.isAlive = false;\n\t  },\n      open: (ws,request) => {\n\t\n\t\tif(ws.id_user){\n\t\t\t\n\t\t\tif(arr_ws[ws.id_user]==undefined)\n\t\t\tarr_ws[ws.id_user] = [ws];\n\t\t\telse\n\t\t\tarr_ws[ws.id_user].push(ws);\n\t\t\tlen++;\n\t\t\tws.isClose = false;\n\t\t\t\n\t\t\tconsole.log('id:'+ws.id_user+' length:'+(arr_ws[ws.id_user]?.length ?? 0)+' in cluster:'+cluster.worker.id);\n\t}\n\telse {\n\t\t\n\t\tws.end();\n\t}\n\t\n      },\n\n\n\n\n\n      message: (client, message /*, isBinary*/) => {\n      },\n      drain: client => {\n        console.log('drain', client, client.getBufferedAmount())\n      },\n      close: (ws, code, message) => {\n\t\tws.isClose = true;\n\t\tws.isAlive = false;\n      }\n    })\n    .listen(port, ws => {\n\t\tif(ws)\n        console.log(`Listening to port ${port}`);\n\t\telse \n\t\tconsole.log('Not listening');\n    })\n\n\n\n\n\t\n\n\t\n\n\n\nfunction clearWSStack(stack){\nvar clearPool = true;\nsetInterval(()=>{\n\t//console.log('start clear');\nif(clearPool){\n\tclearPool = false;\n\tvar keys = Object.keys(stack);\n\tvar start_key = 0;\n\tvar end_key = keys.length;\n\t(function cycleClearPool(key){\n\t\t\n\t\t\n\t\tvar reIndex = false;\n\t\tstack[key]?.forEach((ws,i)=>{\n\t\t\t\n\t\t\tif(!ws.isAlive){\n\t        if(!ws.isClose)ws.close();\n\t        delete stack[key][i];\n\t        reIndex = true;\n\t\t\tconsole.log('delete client');\n\t    \n\t\t}\n\t     \n\t\t});\n\t\t\n\t\tif(reIndex==true)\n\t\t  stack[key] = stack[key].filter(ws=>{\n\t\t\t \n\t\t\t  if(ws!=undefined)return ws;\n\t\t\t  });\n            if(start_key<end_key)\n\t\t\t  setTimeout(()=>cycleClearPool(keys[++start_key]),0);\n\t\t\t  else \n\t\t\t  clearPool = true;\n\t\t\t\n})(keys[start_key]);\n/*\t\nwss.clients.forEach(ws=>{\n\tif(!ws.isAlive) \n\t        ws.terminate();\n\t        else {\n\t\t\t\tconsole.log('z');\n\t        ws.ping();\n\t        ws.isAlive = false;\n\t\t}\n});\n*/\n//console.log('end clear');\n//console.log(process.memoryUsage());\n\n}\n},10000);\n\n}\n\n\n\nclearWSStack(arr_ws);\nclearWSStack(arr_ws_admin);\n\n}\n\n\n\n\n\n"],"mappings":"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"}